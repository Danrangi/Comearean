<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Exam In Progress - {{ exam.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --exam-primary: #0d6efd; --exam-bg: #f4f7f6; }
        body { background-color: var(--exam-bg); overflow: hidden; height: 100vh; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .war-room-header { 
            height: 70px; background: white; border-bottom: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: space-between; padding: 0 25px;
        }
        .tab-btn { 
            padding: 10px 25px; border: none; background: transparent; font-weight: 600; color: #6c757d;
            border-bottom: 3px solid transparent; cursor: pointer; transition: all 0.3s;
        }
        .tab-btn.active { color: var(--exam-primary); border-bottom-color: var(--exam-primary); }
        .timer-display { font-size: 1.4rem; font-weight: 700; font-variant-numeric: tabular-nums; color: #dc3545; }
        .war-room-container { display: flex; height: calc(100vh - 70px); }
        .main-stage { flex: 1; padding: 40px; overflow-y: auto; background: #fff; }
        .nav-map { width: 320px; background: #f8f9fa; border-left: 1px solid #dee2e6; padding: 25px; overflow-y: auto; }
        .question-block { background: #fff; padding: 25px; border-radius: 10px; border: 1px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .option-card { 
            padding: 15px 20px; border: 2px solid #e9ecef; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; position: relative;
        }
        .option-card:hover { border-color: #adb5bd; background: #f8f9fa; }
        .option-card.selected { border-color: var(--exam-primary); background: #e7f1ff; }
        .grid-btn { 
            height: 45px; display: flex; align-items: center; justify-content: center; background: #fff;
            border: 1px solid #dee2e6; text-decoration: none; color: #495057; font-weight: 600; border-radius: 6px;
        }
        .grid-btn.answered { background: var(--exam-primary); color: white; border-color: var(--exam-primary); }
        .calc-modal { display: none; position: fixed; top: 80px; right: 340px; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.2); border-radius: 12px; }
    </style>
</head>
<body>
    <form method="POST" action="{{ url_for('main.submit_exam') }}" id="examForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <input type="hidden" name="exam_name" value="{{ exam.name }}">

        <header class="war-room-header">
            <div class="d-flex gap-2">
                {% for subject_name in exam_data.keys() %}
                <button type="button" class="tab-btn {% if loop.first %}active{% endif %}" 
                        onclick="switchTab({{ loop.index }}, this)" id="tab-btn-{{ loop.index }}">
                    {{ subject_name }}
                </button>
                {% endfor %}
            </div>
            <div class="d-flex align-items-center gap-4">
                <div class="timer-display d-flex align-items-center">
                    <i class="far fa-clock me-2"></i><span id="timer">00:00:00</span>
                </div>
                <button type="button" class="btn btn-outline-secondary" onclick="toggleCalc()">
                    <i class="fas fa-calculator me-2"></i>Calculator
                </button>
                <button type="button" class="btn btn-primary fw-bold px-4" data-bs-toggle="modal" data-bs-target="#submissionModal">
                    Submit Exam
                </button>
            </div>
        </header>

        <div class="war-room-container">
            <div class="main-stage">
                <div class="tab-content h-100">
                    {% for subject_name, items in exam_data.items() %}
                    {% set subject_idx = loop.index %}
                    <div class="tab-pane fade h-100 {% if loop.first %}show active{% endif %}" id="content-{{ subject_idx }}">
                        <div class="h-100 pe-3" style="overflow-y: auto; padding-bottom: 100px;" id="scroll-{{ subject_idx }}">
                            {% for item in items %}
                            {% set question_idx = loop.index %}
                            <div class="question-block mb-5" id="q-{{ subject_idx }}-{{ question_idx }}">
                                <h5 class="fw-bold mb-4"><span class="badge bg-secondary me-2">Q{{ question_idx }}</span> {{ item.q.text }}</h5>
                                <div class="options-list">
                                    {% for opt in item.opts %}
                                    <div class="option-card" onclick="selectOption('q_{{ item.q.id }}', '{{ opt.key }}', this, {{ subject_idx }}, {{ question_idx }})">
                                        <input type="radio" name="q_{{ item.q.id }}" value="{{ opt.key }}" class="d-none">
                                        <strong class="me-2">{{ opt.key }}.</strong> {{ opt.text }}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="nav-map">
                <h6 class="fw-bold mb-4 text-muted text-uppercase small ls-1">Question Palette</h6>
                {% for subject_name, items in exam_data.items() %}
                {% set nav_subject_idx = loop.index %}
                <div class="row g-2 subject-palette {% if not loop.first %}d-none{% endif %}" id="palette-{{ nav_subject_idx }}">
                    {% for item in items %}
                    <div class="col-3">
                        <a href="javascript:void(0)" onclick="scrollToQuestion({{ nav_subject_idx }}, {{ loop.index }})" 
                           class="grid-btn" id="btn-{{ nav_subject_idx }}-{{ loop.index }}">{{ loop.index }}</a>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
    </form>

    <div class="modal fade" id="submissionModal" tabindex="-1" data-bs-backdrop="static" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Confirm Submission</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body py-4">
                    <div class="text-center mb-3">
                        <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                        <p class="lead mb-1">Are you sure you want to end your exam?</p>
                        <p class="text-muted small">You will not be able to change your answers after submitting.</p>
                    </div>
                </div>
                <div class="modal-footer border-0 justify-content-center pb-4">
                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Return to Exam</button>
                    <button type="button" class="btn btn-primary px-4 fw-bold" onclick="document.getElementById('examForm').submit();">Yes, Submit Now</button>
                </div>
            </div>
        </div>
    </div>

    <div class="calc-modal card p-3" id="calculator">
        <input type="text" class="form-control mb-2 text-end fs-5" id="calcDisplay" readonly>
        <div class="row g-2">
            <div class="col-3"><button class="btn btn-danger w-100" onclick="calcClear()">C</button></div>
            <div class="col-3"><button class="btn btn-light w-100" onclick="calcAppend('/')">/</button></div>
            <button class="btn btn-light col-3" onclick="calcAppend('*')">*</button>
            <button class="btn btn-light col-3" onclick="calcAppend('-')">-</button>
            <button class="btn btn-white border col-3" onclick="calcAppend('7')">7</button>
            <button class="btn btn-white border col-3" onclick="calcAppend('8')">8</button>
            <button class="btn btn-white border col-3" onclick="calcAppend('9')">9</button>
            <button class="btn btn-light col-3" onclick="calcAppend('+')">+</button>
            <button class="btn btn-white border col-3" onclick="calcAppend('4')">4</button>
            <button class="btn btn-white border col-3" onclick="calcAppend('5')">5</button>
            <button class="btn btn-white border col-3" onclick="calcAppend('6')">6</button>
            <button class="btn btn-primary col-3" onclick="calcSolve()">=</button>
            <button class="btn btn-white border col-3" onclick="calcAppend('1')">1</button>
            <button class="btn btn-white border col-3" onclick="calcAppend('2')">2</button>
            <button class="btn btn-white border col-3" onclick="calcAppend('3')">3</button>
            <button class="btn btn-white border col-3" onclick="calcAppend('0')">0</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function switchTab(index, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('show', 'active'));
            document.getElementById(`content-${index}`).classList.add('show', 'active');
            document.querySelectorAll('.subject-palette').forEach(p => p.classList.add('d-none'));
            document.getElementById(`palette-${index}`).classList.remove('d-none');
        }

        function selectOption(inputName, value, card, subIdx, qIdx) {
            const radio = card.querySelector('input');
            radio.checked = true;
            card.parentElement.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            const navBtn = document.getElementById(`btn-${subIdx}-${qIdx}`);
            if(navBtn) navBtn.classList.add('answered');
        }

        function scrollToQuestion(subIdx, qIdx) {
            const el = document.getElementById(`q-${subIdx}-${qIdx}`);
            if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function toggleCalc() {
            const calc = document.getElementById('calculator');
            calc.style.display = calc.style.display === 'block' ? 'none' : 'block';
        }
        function calcAppend(v) { document.getElementById('calcDisplay').value += v; }
        function calcClear() { document.getElementById('calcDisplay').value = ''; }
        function calcSolve() { try { document.getElementById('calcDisplay').value = eval(document.getElementById('calcDisplay').value); } catch { document.getElementById('calcDisplay').value = 'Error'; } }

        let timeLeft = {{ exam.duration_minutes * 60 }};
        const timerElem = document.getElementById('timer');
        const countdown = setInterval(() => {
            if (timeLeft <= 0) { 
                clearInterval(countdown); 
                // Auto-submit without modal when time is up
                document.getElementById('examForm').submit(); 
            }
            let h = Math.floor(timeLeft / 3600), m = Math.floor((timeLeft % 3600) / 60), s = timeLeft % 60;
            timerElem.textContent = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            timeLeft--;
        }, 1000);
    </script>
</body>
</html>

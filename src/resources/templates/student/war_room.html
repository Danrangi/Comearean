{% extends 'base.html' %}
{% block content %}
<div class="container-fluid" style="height: 90vh;">
    <form id="examForm" action="{{ url_for('student.take_exam', exam_id=exam.id) }}" method="POST">
        
        <div class="d-flex justify-content-between align-items-center bg-dark text-white p-3 rounded mb-3">
            <h4>{{ exam.name }}</h4>
            <div class="h4" id="timer" style="color: #ff4757; font-weight: bold;">00:00:00</div>
            <button type="submit" class="btn btn-success" onclick="return confirm('Submit exam?');">Submit Exam</button>
        </div>

        <div class="row h-100">
            <div class="col-md-3" style="overflow-y: auto; max-height: 80vh;">
                {% for subject in subjects %}
                <div class="card mb-3">
                    <div class="card-header bg-secondary text-white">{{ subject.name }}</div>
                    <div class="card-body p-2">
                        <div class="d-flex flex-wrap gap-2">
                            {% for question in subject.questions %}
                            <a href="#q_{{ question.id }}" class="btn btn-outline-dark btn-sm" style="width: 40px;">
                                {{ loop.index }}
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="col-md-9" style="overflow-y: auto; max-height: 80vh;">
                {% for subject in subjects %}
                    <h3 class="text-primary mt-4">{{ subject.name }}</h3>
                    <hr>
                    {% for question in subject.questions %}
                    <div class="card mb-4" id="q_{{ question.id }}">
                        <div class="card-body">
                            <h5 class="card-title">Q{{ loop.index }}: {{ question.text }}</h5>
                            <div class="mt-3">
                                {% for opt in ['A', 'B', 'C', 'D'] %}
                                    {% set opt_val = attribute(question, 'option_' + opt.lower()) %}
                                    {% if opt_val %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="q_{{ question.id }}" value="{{ opt }}" id="opt_{{ question.id }}_{{ opt }}">
                                        <label class="form-check-label" for="opt_{{ question.id }}_{{ opt }}">
                                            <strong>{{ opt }}.</strong> {{ opt_val }}
                                        </label>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% endfor %}
            </div>
        </div>
    </form>
</div>

<script>
    // -- TIMER LOGIC --
    // Set duration in minutes (e.g., 60 minutes)
    let duration = 60 * 60; 
    let display = document.querySelector('#timer');

    let timer = setInterval(function () {
        let hours = parseInt(duration / 3600, 10);
        let minutes = parseInt((duration % 3600) / 60, 10);
        let seconds = parseInt(duration % 60, 10);

        hours = hours < 10 ? "0" + hours : hours;
        minutes = minutes < 10 ? "0" + minutes : minutes;
        seconds = seconds < 10 ? "0" + seconds : seconds;

        display.textContent = hours + ":" + minutes + ":" + seconds;

        if (--duration < 0) {
            clearInterval(timer);
            alert("Time is up! Submitting exam...");
            document.getElementById('examForm').submit();
        }
    }, 1000);
</script>
{% endblock %}
